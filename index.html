<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<style>
  body { margin:0; background:black; overflow:hidden; }
  canvas { image-rendering: pixelated; }
</style>
<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.js"></script>
</head>
<body>

<script>
////////////////////////////////////////////////////////////////////////////////
// 設定
////////////////////////////////////////////////////////////////////////////////
const GAME_W = 320;
const GAME_H = 240;
const GAME_ZOOM = 2;

const DOORS = {
  HOME:   { x:145, y:198 },
  BANK:   { x:546, y:200 },
  MART:   { x:586, y:363 },
  CINEMA: { x:387, y:466 }
};

////////////////////////////////////////////////////////////////////////////////
// 共通：プレイヤー生成
////////////////////////////////////////////////////////////////////////////////
function createPlayer(scene, x, y) {
  let p = scene.physics.add.sprite(x, y, "player");
  p.setCollideWorldBounds(true);
  scene.cameras.main.startFollow(p, true, 0.1, 0.1);
  return p;
}

function createPlayerAnimation(scene) {
  scene.anims.create({
      key:"down",
      frames: scene.anims.generateFrameNumbers("player",{ start:0, end:2 }),
      frameRate: 8, repeat:-1
  });
  scene.anims.create({
      key:"left",
      frames: scene.anims.generateFrameNumbers("player",{ start:3, end:5 }),
      frameRate: 8, repeat:-1
  });
  scene.anims.create({
      key:"right",
      frames: scene.anims.generateFrameNumbers("player",{ start:6, end:8 }),
      frameRate: 8, repeat:-1
  });
  scene.anims.create({
      key:"up",
      frames: scene.anims.generateFrameNumbers("player",{ start:9, end:11 }),
      frameRate: 8, repeat:-1
  });
}

function playerMove(player, cursors) {
  const speed = 100;
  player.setVelocity(0);

  if (cursors.left.isDown) {
      player.setVelocityX(-speed);
      player.anims.play("left", true);
  } else if (cursors.right.isDown) {
      player.setVelocityX(speed);
      player.anims.play("right", true);
  } else if (cursors.up.isDown) {
      player.setVelocityY(-speed);
      player.anims.play("up", true);
  } else if (cursors.down.isDown) {
      player.setVelocityY(speed);
      player.anims.play("down", true);
  } else {
      player.anims.stop();
  }
}

////////////////////////////////////////////////////////////////////////////////
// 外マップ Scene
////////////////////////////////////////////////////////////////////////////////
class FieldScene extends Phaser.Scene {
  constructor() { super("field"); }

  preload() {
    this.load.image("map", "assets/map.png");
    this.load.image("homeMap", "assets/home.png");
    this.load.image("bankMap", "assets/bank.png");
    this.load.image("martMap", "assets/mart.png");
    this.load.image("cinemaMap", "assets/cinema.png");
    this.load.spritesheet("player", "assets/player_fixed.png", {
        frameWidth: 32, frameHeight: 32
    });
  }

  create() {
    this.background = this.add.image(0, 0, "map").setOrigin(0, 0);

    this.player = createPlayer(this, 150, 170);
    createPlayerAnimation(this);
    this.cursors = this.input.keyboard.createCursorKeys();

    this.cameras.main.setBounds(0, 0, this.background.width, this.background.height);
    this.physics.world.setBounds(0, 0, this.background.width, this.background.height);

    // 扉の当たり判定
    Object.entries(DOORS).forEach(([name, pos]) => {
      const zone = this.add.zone(pos.x, pos.y, 40, 40);
      this.physics.world.enable(zone);
      zone.body.setAllowGravity(false);
      zone.body.moves = false;

      this.physics.add.overlap(this.player, zone, () => {
         this.scene.start(name.toLowerCase());  // home / bank / mart / cinema
      });
    });
  }

  update() {
    playerMove(this.player, this.cursors);
  }
}

////////////////////////////////////////////////////////////////////////////////
// 内部マップ共通 Scene
////////////////////////////////////////////////////////////////////////////////
class InteriorScene extends Phaser.Scene {
  constructor(key, imageKey, exitX, exitY) {
    super(key);
    this.imageKey = imageKey;
    this.exitX = exitX;
    this.exitY = exitY;
  }

  create() {
    this.bg = this.add.image(0, 0, this.imageKey).setOrigin(0, 0);

    this.player = createPlayer(this, this.exitX, this.exitY);
    createPlayerAnimation(this);
    this.cursors = this.input.keyboard.createCursorKeys();

    this.cameras.main.setBounds(0, 0, this.bg.width, this.bg.height);
    this.physics.world.setBounds(0, 0, this.bg.width, this.bg.height);

    // 出口ゾーン（下に配置）
    const exitZone = this.add.zone(this.exitX, this.exitY + 50, 80, 80);
    this.physics.world.enable(exitZone);
    exitZone.body.moves = false;

    this.physics.add.overlap(this.player, exitZone, () => {
       this.scene.start("field");
    });

    // Bキーでも戻れる
    this.input.keyboard.on("keydown-B", () => {
      this.scene.start("field");
    });
  }

  update() {
    playerMove(this.player, this.cursors);
  }
}

////////////////////////////////////////////////////////////////////////////////
// 各内部マップの Scene 登録
////////////////////////////////////////////////////////////////////////////////
class HomeScene   extends InteriorScene { constructor(){ super("home","homeMap", 380, 650); } }
class BankScene   extends InteriorScene { constructor(){ super("bank","bankMap", 380, 650); } }
class MartScene   extends InteriorScene { constructor(){ super("mart","martMap", 380, 650); } }
class CinemaScene extends InteriorScene { constructor(){ super("cinema","cinemaMap", 380, 650); } }

////////////////////////////////////////////////////////////////////////////////
// Phaser 設定
////////////////////////////////////////////////////////////////////////////////
const config = {
  type: Phaser.AUTO,
  width: GAME_W,
  height: GAME_H,
  zoom: GAME_ZOOM,
  pixelArt: true,
  physics: { default:"arcade", arcade:{debug:false} },
  scene: [FieldScene, HomeScene, BankScene, MartScene, CinemaScene]
};

new Phaser.Game(config);

</script>

</body>
</html>
