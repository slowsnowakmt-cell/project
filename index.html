<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8" />
<title>My Game</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  body { margin:0; background:black; overflow:hidden; }
  canvas { image-rendering: pixelated; }
</style>

<script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
</head>
<body>


<script>
//////////////////////////////////////////////////////////////
// 共通：プレイヤーアニメーション
//////////////////////////////////////////////////////////////
function createPlayerAnimation(scene) {
  scene.anims.create({
    key:"down",
    frames: scene.anims.generateFrameNumbers("player",{ start:0, end:2 }),
    frameRate: 8, repeat:-1
  });
  scene.anims.create({
    key:"left",
    frames: scene.anims.generateFrameNumbers("player",{ start:3, end:5 }),
    frameRate: 8, repeat:-1
  });
  scene.anims.create({
    key:"right",
    frames: scene.anims.generateFrameNumbers("player",{ start:6, end:8 }),
    frameRate: 8, repeat:-1
  });
  scene.anims.create({
    key:"up",
    frames: scene.anims.generateFrameNumbers("player",{ start:9, end:11 }),
    frameRate: 8, repeat:-1
  });
}

function movePlayer(player, cursors) {
  const spd = 120;
  player.setVelocity(0);

  if (cursors.left.isDown)  { player.setVelocityX(-spd); player.anims.play("left", true); }
  else if (cursors.right.isDown) { player.setVelocityX(spd); player.anims.play("right", true); }
  else if (cursors.up.isDown) { player.setVelocityY(-spd); player.anims.play("up", true); }
  else if (cursors.down.isDown) { player.setVelocityY(spd); player.anims.play("down", true); }
  else { player.anims.stop(); }
}

//////////////////////////////////////////////////////////////
// ① MainMap（外マップ）
//////////////////////////////////////////////////////////////
class MainMap extends Phaser.Scene {
  constructor() { super("MainMap"); }

  preload() {
    this.load.image("map", "assets/map.png");
    this.load.spritesheet("player", "assets/player.png", 
      { frameWidth: 32, frameHeight: 32 });
  }

  create() {
    this.add.image(0, 0, "map").setOrigin(0);

    this.player = this.physics.add.sprite(200, 200, "player");
    this.cameras.main.startFollow(this.player);

    this.cursors = this.input.keyboard.createCursorKeys();
    this.keyE = this.input.keyboard.addKey("E");

    createPlayerAnimation(this);

    // 入口座標
    this.doors = {
      home:   { x:145, y:198, w:32, h:32, scene:"Home" },
      bank:   { x:546, y:200, w:32, h:32, scene:"Bank" },
      mart:   { x:586, y:363, w:32, h:32, scene:"Mart" },
      cinema: { x:387, y:466, w:32, h:32, scene:"Cinema" }
    };
  }

  update() {
    movePlayer(this.player, this.cursors);

    if (Phaser.Input.Keyboard.JustDown(this.keyE)) {
      this.tryEnterDoor();
    }
  }

  tryEnterDoor() {
    const p = this.player;
    for (let key in this.doors) {
      const d = this.doors[key];
      if (p.x > d.x && p.x < d.x+d.w &&
          p.y > d.y && p.y < d.y+d.h) {
        
        this.cameras.main.fadeOut(200);
        this.time.delayedCall(200, () => {
          this.scene.start(d.scene);
        });
        return;
      }
    }
  }
}


//////////////////////////////////////////////////////////////
// ② 内部マップ（共通処理）
//////////////////////////////////////////////////////////////
class BaseInterior extends Phaser.Scene {

  setupInterior(imageKey) {
    this.add.image(0, 0, imageKey).setOrigin(0);

    this.player = this.physics.add.sprite(380, 420, "player");
    this.cameras.main.startFollow(this.player);

    this.cursors = this.input.keyboard.createCursorKeys();
    this.keyE = this.input.keyboard.addKey("E");

    createPlayerAnimation(this);

    // 出口座標（下）
    this.exitRect = { x:340, y:470, w:80, h:40 };
  }

  updateBase() {
    movePlayer(this.player, this.cursors);

    if (Phaser.Input.Keyboard.JustDown(this.keyE)) {
      if (this.checkExit()) {
        this.cameras.main.fadeOut(200);
        this.time.delayedCall(200, () => {
          this.scene.start("MainMap");
        });
      }
    }
  }

  checkExit() {
    const p = this.player;
    const e = this.exitRect;
    return (p.x > e.x && p.x < e.x+e.w &&
            p.y > e.y && p.y < e.y+e.h);
  }
}


//////////////////////////////////////////////////////////////
// ③ Home（家）
//////////////////////////////////////////////////////////////
class Home extends BaseInterior {
  constructor() { super("Home"); }

  preload() {
    this.load.image("home", "assets/home_768x512.png");
    this.load.spritesheet("player", "assets/player.png",
      { frameWidth: 32, frameHeight: 32 });
  }

  create() { this.setupInterior("home"); }
  update() { this.updateBase(); }
}

//////////////////////////////////////////////////////////////
// ④ Bank（銀行）
//////////////////////////////////////////////////////////////
class Bank extends BaseInterior {
  constructor() { super("Bank"); }

  preload() {
    this.load.image("bank", "assets/bank_768x512.png");
    this.load.spritesheet("player", "assets/player.png",
      { frameWidth: 32, frameHeight: 32 });
  }

  create() { this.setupInterior("bank"); }
  update() { this.updateBase(); }
}

//////////////////////////////////////////////////////////////
// ⑤ Mart（店）
//////////////////////////////////////////////////////////////
class Mart extends BaseInterior {
  constructor() { super("Mart"); }

  preload() {
    this.load.image("mart", "assets/mart_768x512.png");
    this.load.spritesheet("player", "assets/player.png",
      { frameWidth: 32, frameHeight: 32 });
  }

  create() { this.setupInterior("mart"); }
  update() { this.updateBase(); }
}

//////////////////////////////////////////////////////////////
// ⑥ Cinema（映画館）
//////////////////////////////////////////////////////////////
class Cinema extends BaseInterior {
  constructor() { super("Cinema"); }

  preload() {
    this.load.image("cinema", "assets/cinema_768x512.png");
    this.load.spritesheet("player", "assets/player.png",
      { frameWidth: 32, frameHeight: 32 });
  }

  create() { this.setupInterior("cinema"); }
  update() { this.updateBase(); }
}


//////////////////////////////////////////////////////////////
// Phaser ゲーム開始
//////////////////////////////////////////////////////////////
const config = {
  type: Phaser.AUTO,
  width: 768,
  height: 512,
  pixelArt: true,
  physics: {
    default: "arcade",
    arcade: { debug:false }
  },
  scene: [ MainMap, Home, Bank, Mart, Cinema ]
};

new Phaser.Game(config);
</script>


</body>
</html>
